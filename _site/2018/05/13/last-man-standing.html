<!DOCTYPE html>
<html>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script type="text/x-mathjax-config">
   MathJax.Hub.Config({
     tex2jax: {
     inlineMath: [ ['$','$'], ["\\(","\\)"] ],
     processEscapes: true
   }
});
</script>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" href="//favicon.png">

  <!-- Meta information -->
  <title>Last Man Standing - optimal strategies for betting games</title>
  <meta name="description"
        content="A good friend of mine with a penchant for sports betting told me recently about a new game he’s been playing: Last Man Standing. In this blog post we’re goin...">
  <link rel="canonical"
        href="https://ddervs.github.io///2018/05/13/last-man-standing.html" />

  <!-- hack.css -->
  <link rel="stylesheet" href="https://npmcdn.com/hack/dist/hack.css" />
  

  <!-- Prism.js -->
  <link rel="stylesheet" href="https://npmcdn.com/prismjs@1.5.1/themes/prism.css" />

  <!-- Custom style -->
  <link rel="stylesheet" href="//css/main.css" />

  <!-- Feed -->
  <link rel="alternate" type="application/rss+xml" title="Danial Dervovic"
        href="//feed.xml" />

  <!-- 'jekyll-seo' plugin -->
  <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Last Man Standing - optimal strategies for betting games - Danial Dervovic</title>
<meta property="og:title" content="Last Man Standing - optimal strategies for betting games" />
<meta name="description" content="A good friend of mine with a penchant for sports betting told me recently about a new game he’s been playing: Last Man Standing. In this blog post we’re going to develop strategies for playing this game. Let’s get to it." />
<meta property="og:description" content="A good friend of mine with a penchant for sports betting told me recently about a new game he’s been playing: Last Man Standing. In this blog post we’re going to develop strategies for playing this game. Let’s get to it." />
<link rel="canonical" href="https://ddervs.github.io///2018/05/13/last-man-standing.html" />
<meta property="og:url" content="https://ddervs.github.io///2018/05/13/last-man-standing.html" />
<meta property="og:site_name" content="Danial Dervovic" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-13T15:55:01+01:00" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Last Man Standing - optimal strategies for betting games",
    "datePublished": "2018-05-13T15:55:01+01:00",
    "description": "A good friend of mine with a penchant for sports betting told me recently about a new game he’s been playing: Last Man Standing. In this blog post we’re going to develop strategies for playing this game. Let’s get to it.",
    "url": "https://ddervs.github.io///2018/05/13/last-man-standing.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>



  
  <body class="hack">
  

    <a href="https://github.com/ddervs/" class="github-corner">


  <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>


</a>

<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>


    <div class="container">
      <div class="grid">
        <aside class="cell -3of12" role="navigation">
          <div class="t-hackcss-navigation">
  <h2 class="t-hackcss-navigation-heading">Menu</h2>

  <nav class="menu" role="menubar">
    
    
      <a class="menu-item "
        role="menuitem" href="//" title="">
        Home <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item "
        role="menuitem" href="//blog" title="">
        Blog <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item "
        role="menuitem" href="//papers" title="">
        Papers <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item "
        role="menuitem" href="//outreach" title="">
        Outreach <div class="pull-right">»</div>
      </a>
    
      <a class="menu-item "
        role="menuitem" href="//notes" title="">
        Notes <div class="pull-right">»</div>
      </a>
    
  </nav>

</div>

        </aside>

        <main class="cell -9of12">
          <style>
.grid {
    flex-direction: column;
  }

.cell {
flex: 0 0 auto;
}
</style>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Last Man Standing - optimal strategies for betting games</h1>
    <p class="post-meta">
      <time datetime="2018-05-13T15:55:01+01:00"
            itemprop="datePublished"
            class="media-heading">
        May 13, 2018
      </time>

      
        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <span itemprop="name">danial</span>
        </span>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>A good friend of mine with a penchant for sports betting told me recently about a new game he’s been playing: <a href="https://organise.runlastman.com/how-to-play-premiership/">Last Man Standing</a>. In this blog post we’re going to develop strategies for playing this game. Let’s get to it.</p>

<p><strong>The Rules.</strong></p>

<ul>
  <li>The game starts at the beginning of the English Premier League (EPL) season (or other sports league of your choice).</li>
  <li>There are $M$ players in the game. Each player puts in $x$ units of cash (say, twenty quid).</li>
  <li>Each of the $M$ players chooses one of the $n$ teams in the league. Different players can choose the same team if they wish.</li>
  <li>If a given player’s team wins, they go through to the next week; lose or draw, they’re out.</li>
  <li>The remaining players choose another team that they think will win. Importantly, <em>no player can choose a team they have chosen before</em>.</li>
  <li>This procedure continues until either: there is one player left and they take all the winnings; or, there are no players left and another game begins, starting the next week. The pot rolls over, everyone puts in $x$ monies again and they are each free to choose any team they like again.</li>
  <li>Continue until everyone is broke, apart from the player with the best strategy! Hopefully this will be us by the end of this blog post 😉.</li>
</ul>

<p>The moment my pal told me about this I was hooked. This seemed exactly like the kind of game amenable to some mathematical and algorithmic analysis – potentially giving the informed player an edge over their unwitting opponents. What follows is my winding path of thoughts and strategies on how to play this game.</p>

<h2 id="formalised-model">Formalised model</h2>

<p>The first thing to do when thinking about this was to create a mathematical model of the game.</p>

<p>First, we have $n$ teams. We impose a linear ordering of the teams, i.e., the $1$st team is Arsenal, the $2$nd team is Chelsea etc – we will refer to a team simply by its index $j \in [n]$ (where $n:={1,2,\ldots, n}$). Naturally, a <em>strategy</em> is then defined as ordered list of integers from $[n]$, with no repeats. Optimistically, we hope we won’t lose at any round so we specify a strategy as the longest possible list. The resulting list is a <a href="https://en.wikipedia.org/wiki/Permutation"><em>permutation</em></a>, $\sigma \in \mathbb{S}_n$, where $\mathbb{S}_n$ is the symmetric group on $n$ elements.</p>

<p>Note an individual season will require two consecutive strategies in the best case, as each team plays home and away (concretely, in the EPL each pair of teams plays a match against each other twice per season). Without loss of generality we can consider the single best strategy from any chosen starting point in the season. When we must start again (i.e. when all our choices win, or more likely, one loses and we start playing again), recalculate the best strategy from the new starting point.</p>

<hr />

<p>Now we have a formal notion for a strategy (as a permutation $\sigma \in \mathbb{S}_n$) we need to specify how to evaluate the various strategies. Note that the number of possible strategies is large ($n! \sim 10^{18}$ for the EPL). Let’s take the most natural measure: how likely is it that a strategy wins? Namely,</p>

<script type="math/tex; mode=display">\operatorname{VAL}(\sigma) := \mathbb{P}(\sigma \text{ wins} ) = \mathbb{P}( \omega^{(1)}_{\sigma(1)} \cap \omega^{(2)}_{\sigma(2)} \cap \cdots \cap \omega^{(n)}_{\sigma(n)} ),</script>

<p>where $\omega^{(i)}$${}<em>{j}$ is the event that team $j$ wins in week $i$ and we define $\operatorname{VAL}(\sigma)$ as the *value* of a strategy $\sigma \in \mathbb{S}_n$. Of course, the best strategy $\sigma^\star$ is the one with highest probability of winning, i.e. $\sigma^\star := \arg \max</em>{\sigma \in \mathbb{S}_n} \operatorname{VAL}(\sigma)$.</p>

<p>Now we run into our first problem: how to evaluate $\operatorname{VAL}(\sigma)$. This involves computing $\mathbb{P}(\sigma \text{ wins} )$. Now we don’t even know if this probability is well defined, different probabilistic models will return different values. Moreover, there are $n!$ strategies, so evaluating each strategy separately will be intractable. We <em>need</em> a simplifying assumption. First, let’s introduce some notation:</p>

<script type="math/tex; mode=display">p^{(i)}_j = \mathbb{P} \left( \text{team }j\text{ wins in week }i \right) = \mathbb{P}(\omega^{(i)}_j).</script>

<p>We’re going to make the following assumption:</p>

<p><strong>Assumption 1.</strong> <em>The winning probabilities $p^{(i)}_j$ are independent, for all $i,j\in [n]$.</em></p>

<p>This assumption clearly doesn’t hold in reality. Consider the following scenario: team $j$ plays team $j’$ in week $i$. Then $p^{(i)}<em>j + p^{(i)}</em>{j’} \leq 1$ since both teams can’t win at the same time! One could consider numerous other scenarios in which this model fails, for instance think about a ‘winning streak’ – teams that have in previous weeks are likely to keep winning, due to some underlying factor such as a new great manager etc.</p>

<p>Nevertheless, we are going to work within the independence model as it will make the winning probabilities tractable. We are going to approximate $\operatorname{VAL}(\sigma)$ in the following way:</p>

<script type="math/tex; mode=display">\widetilde{\operatorname{VAL}}(\sigma) = \prod_{i \in [n]} p^{(i)}_{\sigma(i)},</script>

<p>i.e. using the product of the winning probabilities, which is just the joint winning probability $\mathbb{P}(\sigma \text{ wins})$ for the teams ordered according to the strategy $\sigma$, under the independence assumption (Assumption 1).</p>

<p>We can now formally define the Last Man Standing problem $(\mathsf{LMS})$.</p>

<p><strong>Problem ($\mathsf{LMS}$).</strong> Let $p^{(i)}_j \in (0, 1)$ for $i,j \in [n]$. Then, find</p>

<script type="math/tex; mode=display">\tag{$\mathsf{LMS}$} \widetilde{\sigma}^\star = \arg \max_{\sigma \in \mathbb{S_n}}\widetilde{\operatorname{VAL}}(\sigma).</script>

<p><em>Note.</em> The domain of the $p^{(i)}_j$ is the open interval $(0,1)$ as opposed to the closed interval $[0,1]$ since a team is never 100% likely to win or lose.</p>

<h2 id="implementation">Implementation</h2>

<p>Great, we now have a concrete mathematical problem we would like to solve, but it would be good to apply to some concrete data. Namely, where do we get the winning probabilities $p^{(i)}_j$? I thought about this for a while and came to the conclusion that no one is going to be better at calculating the chances of different of outcomes of sports games than bookmakers. Duh! Now we just need bookies’ odds data from somewhere…</p>

<p>Fortunately, the excellent <code class="highlighter-rouge">footballdata</code> python package gives us everything we need in a nice <code class="highlighter-rouge">pandas</code> DataFrame format. Let’s explore a little bit.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s">'retina'</span>

<span class="kn">import</span> <span class="nn">footballdata</span> <span class="kn">as</span> <span class="nn">foo</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="kn">as</span> <span class="nn">cvx</span>

<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">figure</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">import</span> <span class="nn">pprint</span> <span class="kn">as</span> <span class="nn">pp</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">MatchHistory</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Provides pandas.DataFrames from CSV files available at
    http://www.football-data.co.uk/data.php

    Column names are explained here: http://www.football-data.co.uk/notes.txt

    Data will be downloaded as necessary and cached locally in ./data

    Parameters
    ----------
    leagues : string or iterable of league-ids to include, None for all
    seasons : string, int or list of seasons. Examples:
              '16-17'; 2016; '2016-17'; [14, 15, 16]
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">foo</span><span class="o">.</span><span class="n">MatchHistory</span><span class="o">.</span><span class="n">available_leagues</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>['BEL-Jupiler League',
 'ENG-Championship',
 'ENG-Conference',
 'ENG-League 1',
 'ENG-League 2',
 'ENG-Premier League',
 'ESP-La Liga',
 'ESP-La Liga 2',
 'FRA-Ligue 1',
 'FRA-Ligue 2',
 'GER-Bundesliga',
 'GER-Bundesliga 2',
 'GRE-Ethniki Katigoria',
 'ITA-Serie A',
 'ITA-Serie B',
 'NED-Eredivisie',
 'POR-Liga 1',
 'SCO-Division 1',
 'SCO-Division 2',
 'SCO-Division 3',
 'SCO-Premiership',
 'TUR-Ligi 1']
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">prem</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">MatchHistory</span><span class="p">(</span><span class="s">'ENG-Premier League'</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">2017</span><span class="p">))</span><span class="o">.</span><span class="n">read_games</span><span class="p">()</span>
<span class="n">prem</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre>
</div>

<div class="table-container">
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>date</th>
      <th>home_team</th>
      <th>away_team</th>
      <th>FTHG</th>
      <th>FTAG</th>
      <th>FTR</th>
      <th>HTHG</th>
      <th>HTAG</th>
      <th>HTR</th>
      <th>Referee</th>
      <th>...</th>
      <th>BbAv&lt;2.5</th>
      <th>BbAH</th>
      <th>BbAHh</th>
      <th>BbMxAHH</th>
      <th>BbAvAHH</th>
      <th>BbMxAHA</th>
      <th>BbAvAHA</th>
      <th>PSCH</th>
      <th>PSCD</th>
      <th>PSCA</th>
    </tr>
    <tr>
      <th>league</th>
      <th>season</th>
      <th>game_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">ENG-Premier League</th>
      <th rowspan="5" valign="top">1617</th>
      <th>2017-05-12 West Bromwich Albion-Chelsea</th>
      <td>2017-05-12</td>
      <td>West Bromwich Albion</td>
      <td>Chelsea</td>
      <td>0</td>
      <td>1</td>
      <td>A</td>
      <td>0</td>
      <td>0</td>
      <td>D</td>
      <td>M Oliver</td>
      <td>...</td>
      <td>1.99</td>
      <td>20</td>
      <td>1.25</td>
      <td>2.06</td>
      <td>2.02</td>
      <td>1.89</td>
      <td>1.85</td>
      <td>9.76</td>
      <td>5.18</td>
      <td>1.38</td>
    </tr>
    <tr>
      <th>2017-04-15 Tottenham Hotspur-AFC Bournemouth</th>
      <td>2017-04-15</td>
      <td>Tottenham Hotspur</td>
      <td>AFC Bournemouth</td>
      <td>4</td>
      <td>0</td>
      <td>H</td>
      <td>2</td>
      <td>0</td>
      <td>H</td>
      <td>M Oliver</td>
      <td>...</td>
      <td>2.80</td>
      <td>21</td>
      <td>-1.75</td>
      <td>1.98</td>
      <td>1.92</td>
      <td>2.01</td>
      <td>1.95</td>
      <td>1.25</td>
      <td>7.00</td>
      <td>12.80</td>
    </tr>
    <tr>
      <th>2017-04-30 Manchester United-Swansea City</th>
      <td>2017-04-30</td>
      <td>Manchester United</td>
      <td>Swansea City</td>
      <td>1</td>
      <td>1</td>
      <td>D</td>
      <td>1</td>
      <td>0</td>
      <td>H</td>
      <td>N Swarbrick</td>
      <td>...</td>
      <td>2.03</td>
      <td>21</td>
      <td>-1.50</td>
      <td>2.21</td>
      <td>2.14</td>
      <td>1.78</td>
      <td>1.74</td>
      <td>1.42</td>
      <td>4.79</td>
      <td>9.45</td>
    </tr>
    <tr>
      <th>2016-10-29 Manchester United-Burnley</th>
      <td>2016-10-29</td>
      <td>Manchester United</td>
      <td>Burnley</td>
      <td>0</td>
      <td>0</td>
      <td>D</td>
      <td>0</td>
      <td>0</td>
      <td>D</td>
      <td>M Clattenburg</td>
      <td>...</td>
      <td>2.12</td>
      <td>36</td>
      <td>-2.00</td>
      <td>2.13</td>
      <td>2.05</td>
      <td>1.85</td>
      <td>1.80</td>
      <td>1.26</td>
      <td>6.40</td>
      <td>14.25</td>
    </tr>
    <tr>
      <th>2017-05-21 Leicester City-AFC Bournemouth</th>
      <td>2017-05-21</td>
      <td>Leicester City</td>
      <td>AFC Bournemouth</td>
      <td>1</td>
      <td>1</td>
      <td>D</td>
      <td>0</td>
      <td>1</td>
      <td>A</td>
      <td>l Mason</td>
      <td>...</td>
      <td>2.23</td>
      <td>17</td>
      <td>-0.50</td>
      <td>1.95</td>
      <td>1.89</td>
      <td>2.03</td>
      <td>1.98</td>
      <td>1.69</td>
      <td>4.50</td>
      <td>4.81</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 64 columns</p>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">prem</span><span class="p">))</span> <span class="c"># columns of DataFrame</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>['date', 'home_team', 'away_team', 'FTHG', 'FTAG', 'FTR', 'HTHG', 'HTAG', 'HTR', 'Referee', 'HS', 'AS', 'HST', 'AST', 'HF', 'AF', 'HC', 'AC', 'HY', 'AY', 'HR', 'AR', 'B365H', 'B365D', 'B365A', 'BWH', 'BWD', 'BWA', 'IWH', 'IWD', 'IWA', 'LBH', 'LBD', 'LBA', 'PSH', 'PSD', 'PSA', 'WHH', 'WHD', 'WHA', 'VCH', 'VCD', 'VCA', 'Bb1X2', 'BbMxH', 'BbAvH', 'BbMxD', 'BbAvD', 'BbMxA', 'BbAvA', 'BbOU', 'BbMx&gt;2.5', 'BbAv&gt;2.5', 'BbMx&lt;2.5', 'BbAv&lt;2.5', 'BbAH', 'BbAHh', 'BbMxAHH', 'BbAvAHH', 'BbMxAHA', 'BbAvAHA', 'PSCH', 'PSCD', 'PSCA']
</code></pre>
</div>

<p>We can see for the 2016-2017 premiership season we have a variety of bookies we can go to – these are the fields ending in ‘H’, ‘D’ and ‘A’; corresponding to ‘home win’, ‘draw’ and ‘away win’ respectively. Here we are given the odds in European format. We will need to convert these odds into a probability.</p>

<h3 id="computing-probabilities-from-odds">Computing probabilities from odds</h3>

<p>European odds are given as a decimal number equalling <code class="highlighter-rouge">bookies_payout/betters_stake</code>. As an example, European odds of 1.40 mean that if you stake £100, the bet (if successful) will payout £140, and your profit will be £40.</p>

<p>Odds don’t correspond directly with the probabilities, since the bookies need their cut for whichever outcome takes place! We assume that the bookies’ cut, or <em>vig</em> is factored in proportionally with the odds. The bookmaker prices the decimal odds $d_E$ for an event $E$ as</p>

<script type="math/tex; mode=display">d_E = \frac{1}{p_E + o_E},</script>

<p>where $p_E$ is their estimated probability for $E$ and $o_E$ is the overround for $E$. The overround is the relative form of the vig, i.e. the vig is the bookmaker’s percentage profit on the total stakes made on the event, whereas the overround is the expected profit. For example, 20% overround is vigorish of 16 2/3%</p>

<p>We have $o_E = o$ for all $E \in \Omega$, where $\Omega$ is the event set, since we assume the vig is priced proportionally to the odds.</p>

<p>We can then solve for the probabilities like so:</p>

<script type="math/tex; mode=display">\frac{1}{d_E}= p_E + o_E = p_E + o</script>

<p>and</p>

<script type="math/tex; mode=display">\sum_{E' \in \Omega} \frac{1}{d_{E'}} = 1 + \sum_{E' \in \Omega}{o_{E'}} = 1 + \vert\Omega\vert o.</script>

<p>So, $o = \frac{1}{\vert\Omega\vert}\left( \sum_{E’ \in \Omega} \frac{1}{d_{E’}} - 1 \right)$ and we have</p>

<script type="math/tex; mode=display">p_E = \frac{1}{d_E} -  \frac{1}{\vert\Omega\vert} \left(\sum_{E' \in \Omega} \frac{1}{d_{E'}} - 1 \right) = \frac{1}{\vert\Omega\vert} + \frac{1}{d_E} - \frac{1}{\vert\Omega\vert}\sum_{E' \in \Omega} \frac{1}{d_{E'}}.</script>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">probs_from_odds</span><span class="p">(</span><span class="n">odds_home</span><span class="p">,</span> <span class="n">odds_draw</span><span class="p">,</span> <span class="n">odds_away</span><span class="p">):</span>
    <span class="n">sum_reciprocol_odds</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">odds_home</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">odds_draw</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">odds_away</span>
    <span class="n">summand</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sum_reciprocol_odds</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">prob_home</span><span class="p">,</span> <span class="n">prob_draw</span><span class="p">,</span> <span class="n">prob_away</span> <span class="o">=</span> \
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">odds</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">odds</span> <span class="o">+</span>  <span class="n">summand</span><span class="p">,</span> <span class="p">[</span><span class="n">odds_home</span><span class="p">,</span> <span class="n">odds_draw</span><span class="p">,</span> <span class="n">odds_away</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">prob_home</span><span class="p">,</span> <span class="n">prob_draw</span><span class="p">,</span> <span class="n">prob_away</span>
</code></pre>
</div>

<h3 id="team-names">Team names</h3>

<p>Below we number the teams, i.e. establish the correspondence $\text{team name} \mapsto j \in [n]$.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">teams</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">prem</span><span class="o">.</span><span class="n">home_team</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">teams</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>['Burnley', 'Crystal Palace', 'Everton', 'Hull City', 'Manchester City', 'Middlesbrough', 'Southampton', 'AFC Bournemouth', 'Arsenal', 'Chelsea', 'Manchester United', 'Leicester City', 'Stoke City', 'Swansea City', 'Tottenham Hotspur', 'Watford', 'West Bromwich Albion', 'Sunderland', 'West Ham United', 'Liverpool']
</code></pre>
</div>

<h2 id="winning-probabilities-matrix">Winning probabilities matrix</h2>

<p>What we want now is the matrix $X\in [0,1]^{38 \times 20}$, with elements defined by</p>

<script type="math/tex; mode=display">X_{i,j} := p^{(i)}_j = \text{probability that team }j\text{ wins in week }i.</script>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">build_X</span><span class="p">(</span><span class="n">league</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">bookie_name</span><span class="p">)</span>
    <span class="n">num_teams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_teams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">num_teams</span><span class="p">))</span>
    <span class="n">X_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_teams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">num_teams</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">games_played_by_team</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="c"># array keeps track of how many games each team has played</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">league</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">j_home</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"home_team"</span><span class="p">])</span>
        <span class="n">j_away</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">"away_team"</span><span class="p">])</span>
        <span class="n">i_home</span> <span class="o">=</span> <span class="n">games_played_by_team</span><span class="p">[</span><span class="n">j_home</span><span class="p">]</span>
        <span class="n">i_away</span> <span class="o">=</span> <span class="n">games_played_by_team</span><span class="p">[</span><span class="n">j_away</span><span class="p">]</span>
        <span class="n">home_prob</span><span class="p">,</span> <span class="n">draw_prob</span><span class="p">,</span> <span class="n">away_prob</span> <span class="o">=</span> <span class="n">probs_from_odds</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">bookie_name</span> <span class="o">+</span> <span class="s">"H"</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">bookie_name</span> <span class="o">+</span> <span class="s">"D"</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">bookie_name</span> <span class="o">+</span> <span class="s">"A"</span><span class="p">])</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i_home</span><span class="p">,</span> <span class="n">j_home</span><span class="p">]</span> <span class="o">=</span> <span class="n">home_prob</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i_away</span><span class="p">,</span> <span class="n">j_away</span><span class="p">]</span> <span class="o">=</span> <span class="n">away_prob</span>
        <span class="n">X_index</span><span class="p">[</span><span class="n">i_home</span><span class="p">,</span> <span class="n">j_home</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">X_index</span><span class="p">[</span><span class="n">i_away</span><span class="p">,</span> <span class="n">j_away</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">games_played_by_team</span><span class="p">[</span><span class="n">j_home</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">games_played_by_team</span><span class="p">[</span><span class="n">j_away</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">X</span>    
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">X</span> <span class="o">=</span> <span class="n">build_X</span><span class="p">(</span><span class="n">prem</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="s">"B365"</span><span class="p">)</span>
</code></pre>
</div>

<h3 id="practical-concerns">Practical concerns</h3>

<p>The winning probabilities will be (very) small, even for the best ones. So let’s use the $\log(\widetilde{\text{VAL}})$ of the winning probability as our metric of ‘goodness’ for a strategy, since $\log(x)$ is a monotonic function of $x \in (0, 1]$.</p>

<p>We also want to be able to convert a permutation back into a list of teams</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">evaluate_perm</span><span class="p">(</span><span class="n">perm_list</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="s">"""
      Gives log of winning probability of a permutation
    """</span>
    <span class="n">winning_probs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perm_list</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perm_list</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">winning_probs</span><span class="p">))</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">team_order_from_perm_list</span><span class="p">(</span><span class="n">perm_list</span><span class="p">,</span> <span class="n">teams</span><span class="p">):</span>
    <span class="s">"""
        takes a list of integers and returns corresponding list of teams
    """</span>
    <span class="c">## check list 'full'</span>
    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">perm_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perm_list</span><span class="p">))))):</span>
        <span class="k">raise</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">(</span><span class="s">"perm_list doesn't contain all integers from 0 to </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perm_list</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)))</span>
    <span class="n">team_choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">teams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">perm_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">team_choice</span>
</code></pre>
</div>

<h1 id="strategies">Strategies</h1>

<p>We now have all the necessary ingredients to start deriving and evaluating strategies.</p>

<h2 id="greedy-strategy">Greedy strategy</h2>

<p>First of all, let’s do the most simple thing we can do: at each time, pick the team out of those you are allowed to with the highest winning probability for that week. We’ll call this the <em>greedy strategy</em>.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greedy_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">):</span>
    <span class="s">"""
        Given winning probability matrix X returns the "greedy" strategy
        permutation of teams - given as a list of integers.
    """</span>
    <span class="c">## Check dims of X ok</span>
    <span class="n">num_weeks</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_teams</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_teams</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)):</span>
        <span class="k">raise</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">(</span><span class="s">"X needs to have </span><span class="si">%</span><span class="s">d rows, has </span><span class="si">%</span><span class="s">d."</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_teams</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="c"># generate sample</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_teams</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">))):</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_teams</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">allowed</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">allowed</span><span class="p">])</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">allowed</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visited</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">greedy_perm</span> <span class="o">=</span> <span class="n">greedy_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span>
<span class="n">greedy_strategy_result</span> <span class="o">=</span> <span class="p">{</span><span class="s">"opt_perm"</span><span class="p">:</span> <span class="n">greedy_perm</span><span class="p">,</span> \
                          <span class="s">"opt_value"</span><span class="p">:</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">greedy_perm</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span> \
                          <span class="s">"opt_team_list"</span><span class="p">:</span> <span class="n">team_order_from_perm_list</span><span class="p">(</span><span class="n">greedy_perm</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span>\
                         <span class="p">}</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">greedy_strategy_result</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">'opt_perm':</span><span class="w"> </span><span class="err">[4,</span><span class="w"> </span><span class="err">14,</span><span class="w"> </span><span class="err">9,</span><span class="w"> </span><span class="err">8,</span><span class="w"> </span><span class="err">11,</span><span class="w"> </span><span class="err">19,</span><span class="w"> </span><span class="err">10,</span><span class="w"> </span><span class="err">6,</span><span class="w"> </span><span class="err">18,</span><span class="w"> </span><span class="err">15,</span><span class="w"> </span><span class="err">7,</span><span class="w"> </span><span class="err">2,</span><span class="w"> </span><span class="err">16,</span><span class="w"> </span><span class="err">12,</span><span class="w"> </span><span class="err">13,</span><span class="w"> </span><span class="err">1,</span><span class="w"> </span><span class="err">5,</span><span class="w"> </span><span class="err">0,</span><span class="w"> </span><span class="err">17,</span><span class="w">
              </span><span class="err">3],</span><span class="w">
 </span><span class="err">'opt_team_list':</span><span class="w"> </span><span class="err">['Manchester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Tottenham</span><span class="w"> </span><span class="err">Hotspur',</span><span class="w"> </span><span class="err">'Chelsea',</span><span class="w"> </span><span class="err">'Arsenal',</span><span class="w">
                   </span><span class="err">'Leicester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Liverpool',</span><span class="w"> </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">United',</span><span class="w">
                   </span><span class="err">'Southampton',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Ham</span><span class="w"> </span><span class="err">United',</span><span class="w"> </span><span class="err">'Watford',</span><span class="w">
                   </span><span class="err">'AFC</span><span class="w"> </span><span class="err">Bournemouth',</span><span class="w"> </span><span class="err">'Everton',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Bromwich</span><span class="w"> </span><span class="err">Albion',</span><span class="w">
                   </span><span class="err">'Stoke</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Swansea</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Crystal</span><span class="w"> </span><span class="err">Palace',</span><span class="w">
                   </span><span class="err">'Middlesbrough',</span><span class="w"> </span><span class="err">'Burnley',</span><span class="w"> </span><span class="err">'Sunderland',</span><span class="w"> </span><span class="err">'Hull</span><span class="w"> </span><span class="err">City'],</span><span class="w">
 </span><span class="err">'opt_value':</span><span class="w"> </span><span class="err">-13.507040869365095</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>So by our earlier reasoning, any permutation of teams we can find that is higher than <code class="highlighter-rouge">greedy_strategy_result["opt_value"]</code> is a success!</p>

<h2 id="greedy-sampling-strategy">Greedy sampling strategy</h2>

<p>Now let’s do the second simplest thing we can think of.</p>

<p><strong>Greedy sampling (GS).</strong>  At each timestep $t$, look at the teams that haven’t previously been chosen. Choose a team randomly, where the probability is proportional to the odds of that team winning in week $t$.</p>

<p>More formally, let $\mathcal{A}(t)$ be the set of teams allowed at time $t$, i.e. those that have not been chosen in times $1,2,\ldots,t-1$. Then,</p>

<script type="math/tex; mode=display">\mathbb{P}\{ \text{choose team }j \text{ at time } t\} = \frac{p^{(t)}_j}{\sum_{k \in \mathcal{A}(t)} p^{(t)}_k}.</script>

<p>Let’s try and provide some rough theoretical justification for this method of generating permutations of teams (you can skip this part if you believe me that this is an OK thing to do).</p>

<hr />

<p>Suppose we have have chosen the permutation $\sigma = (\sigma(1), \sigma(2), \ldots, \sigma(n))$ according to the greedy sampling scheme. The probability of choosing this permutation is</p>

<script type="math/tex; mode=display">\mathbb{P}_{\sigma \sim \text{GS}}(\sigma) = \frac{p^{(1)}_{\sigma(1)}}{\sum_{k \in [n]} p^{(1)}_{k}} \cdot \frac{p^{(2)}_{\sigma(2)}}{\sum_{k \in [n]\setminus \{\sigma(1)\}} p^{(2)}_{k}} \cdot \frac{p^{(3)}_{\sigma(3)}}{\sum_{k \in [n]\setminus \{\sigma(1), \sigma(2)\}} p^{(3)}_{k}} \cdot \cdots \cdot  \frac{p^{(n-1)}_{\sigma(n-1)}}{\sum_{k \in [n]\setminus \{\sigma(1), \sigma(2), \ldots, \sigma(n-2)\}} p^{(n-1)}_{k}} \cdot 1 .</script>

<p>We then have that</p>

<script type="math/tex; mode=display">\mathbb{P}\{\sigma \text{ wins}\} = p^{(n)}_{\sigma(n)} \cdot \left( \sum_{k \in [n]\setminus \{\sigma(1), \sigma(2), \ldots, \sigma(n-2)\}} p^{(n-1)}_{k} \right) \cdot \cdots \cdot \left( \sum_{k \in [n]} p^{(1)}_{k} \right) \cdot \mathbb{P}_{\sigma \sim \text{GS}}(\sigma).</script>

<p>Let’s consider two permutations $\sigma_A$ and $\sigma_B$ and take the ratio of the winning probabilities:</p>

<script type="math/tex; mode=display">\frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}} = \frac{p^{(n)}_{\sigma_A(n)} \cdot \left( \sum_{k \in [n]\setminus \{\sigma_A(1), \sigma_A(2), \ldots, \sigma_A(n-2)\}} p^{(n-1)}_{k} \right) \cdot \cdots \cdot \left( \sum_{k \in [n]} p^{(1)}_{k} \right)}{ 
p^{(n)}_{\sigma_B(n)} \cdot \left( \sum_{k \in [n]\setminus \{\sigma_B(1), \sigma_B(2), \ldots, \sigma_B(n-2)\}} p^{(n-1)}_{k} \right) \cdot \cdots \cdot \left( \sum_{k \in [n]} p^{(1)}_{k} \right)
} \cdot \frac{\mathbb{P}_{\sigma_A \sim \text{GS}}(\sigma_A)}{\mathbb{P}_{\sigma_B \sim \text{GS}}(\sigma_B)}</script>

<p>That’s a pretty hairy equation, so let’s simplify with a bit of new notation: let $S_\sigma^{(t)} = [n]\setminus {\sigma(1), \sigma(2), \ldots, \sigma(t)}$ for $t\in{0,1,\ldots, n}$. Just to clarify:</p>

<script type="math/tex; mode=display">S^{(n)}_\sigma = \emptyset, \ S^{(n-1)}_\sigma = \{ \sigma(n) \},\ \ldots, \ S^{1}_\sigma = [n] \setminus \{\sigma(1)\},\ S^{(0)}_\sigma = [n]</script>

<p>and $\left\vert S^{(t)}_\sigma\right\vert = n-t$. Moreover, let’s call the ratio</p>

<script type="math/tex; mode=display">R^{(t)} = \frac{\sum_{k\in S^{(t -1 )}_{\sigma_A}} p_k^{(t)} } 
{\sum_{k\in S^{(t -1 )}_{\sigma_B}} p_k^{(t)}}</script>

<p>for $t \in {1,\ldots, n} $. We can now have the more succinct</p>

<script type="math/tex; mode=display">\frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}} = \prod^{n}_{t=1}R^{(t)} \cdot \frac{\mathbb{P}_{\sigma_A \sim \text{GS}}(\sigma_A)}{\mathbb{P}_{\sigma_B \sim \text{GS}}(\sigma_B)}</script>

<p>Now for the dodgy bit: let’s now assume that we choose the permutations $\sigma_A, \sigma_B \sim \operatorname{Uni}(\mathbb{S}<em>n)$, i.e. uniformly at random; and that the $p^{(i)}_j$ are independent (Assumption 1) and identically distributed on the open interval $(0,1)$. Moreover, define $\mu = \mathbb{E}[p^{(i)}_j]$. Let us try and estimate the quantity $\mathbb{E}\left[ \frac{1}{\prod^{n}</em>{t=1}R^{(t)}} \cdot \frac{\mathbb{P}{\sigma_A \text{ wins}}}{\mathbb{P}{\sigma_B \text{ wins}}} \right]$ as a proxy for the ratio $\frac{\mathbb{P}<em>{\sigma_A \sim \text{GS}}(\sigma_A)}{\mathbb{P}</em>{\sigma_B \sim \text{GS}}(\sigma_B)}$. We then have</p>

<script type="math/tex; mode=display">\mathbb{E}\left[ \frac{1}{\prod^{n}_{t=1}R^{(t)}} \cdot \frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}} \right] = \mathbb{E}\left[ \prod^{n}_{t=1}R^{(t)} \cdot \frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}} \right] = \mathbb{E}\left[ \prod^{n}_{t=1}R^{(t)}\right] \cdot \frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}},</script>

<p>where we obtain the first equality by symmetry and the second from linearity of expectation.</p>

<p>Let’s now take the expectation value of $\prod^{n}_{t=1}R^{(t)}$. By linearity of expectation, we have that</p>

<script type="math/tex; mode=display">\mathbb{E} \left[ \prod^{n}_{t=1}R^{(t)} \right] = \prod^{n}_{t=1} \mathbb{E} \left[ R^{(t)}\right].</script>

<p>Now,</p>

<script type="math/tex; mode=display">\mathbb{E} \left[ R^{(t)}\right] = \frac{1}{n!} \sum_{\sigma_A \in \mathbb{S}_n} \sum_{k \in S^{(t)}_{\sigma_A}} \mathbb{E}\left[ p^{(t)}_k \right] \cdot \frac{1}{n!} \sum_{\sigma_B \in \mathbb{S}_n}\frac{1}{ \sum_{k \in S^{(t)}_{\sigma_B}} \mathbb{E}\left[ p^{(t)}_k \right]} \\
= \frac{1}{n!} \sum_{\sigma_A \in \mathbb{S}_n} \sum_{k \in S^{(t)}_{\sigma_A}} \mu \cdot \frac{1}{n!} \sum_{\sigma_B \in \mathbb{S}_n} \frac{1}{\sum_{k \in S^{(t)}_{\sigma_B}} \mu} \\
\frac{1}{n!} \sum_{\sigma_A \in \mathbb{S}_n} (n-t) \mu \cdot \frac{1}{n!} \sum_{\sigma_B \in \mathbb{S}_n} \frac{1}{(n-t) \mu} = 1.</script>

<p>So that means, under some somewhat shaky assumptions, we have</p>

<script type="math/tex; mode=display">\frac{\mathbb{P}_{\sigma_A \sim \text{GS}}(\sigma_A)}{\mathbb{P}_{\sigma_B \sim \text{GS}}(\sigma_B)} \approx
\frac{\mathbb{P}\{\sigma_A \text{ wins}\}}{\mathbb{P}\{\sigma_B \text{ wins}\}} ,</script>

<p>so sampling permutations from the GS distribution hopefully gives us samples somewhat consistent with sampling permutations with probability proportional to their winning probabilities – that is – the permutation with the highest winning probability should be sampled with the highest probability according to GS.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greedy_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">):</span>
    <span class="s">"""
        Given winning probability matrix X returns a "greedy" sample
        permutation of teams - given as a list of integers.
    """</span>
    <span class="c">## Check dims of X ok</span>
    <span class="n">num_weeks</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_teams</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_teams</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)):</span>
        <span class="k">raise</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">(</span><span class="s">"X needs to have </span><span class="si">%</span><span class="s">d rows, has </span><span class="si">%</span><span class="s">d."</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_teams</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="c"># generate samples</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_teams</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">))):</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_teams</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">]</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">allowed</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">allowed</span><span class="p">])</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">allowed</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">visited</span>
</code></pre>
</div>

<h3 id="take-many-greedy-samples-and-save-the-best">Take many greedy samples and save the best</h3>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">greedy_sample_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">):</span>
    <span class="n">optimal_sampled_perm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">optimal_value</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s">"inf"</span><span class="p">)</span>
    <span class="n">optimal_t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Run </span><span class="si">%</span><span class="s">d of </span><span class="si">%</span><span class="s">d. Current optimal value is </span><span class="si">%.4</span><span class="s">f observed at run </span><span class="si">%</span><span class="s">d."</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">,</span> <span class="n">optimal_value</span><span class="p">,</span> <span class="n">optimal_t</span><span class="p">))</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">greedy_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">optimal_value</span><span class="p">):</span>
            <span class="n">optimal_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">optimal_sampled_perm</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[:]</span>
            <span class="n">optimal_t</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">optimal_sampled_perm</span><span class="p">,</span> <span class="n">optimal_value</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">num_iterations</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">greedy_opt_perm</span><span class="p">,</span> <span class="n">greedy_opt_val</span> <span class="o">=</span> <span class="n">greedy_sample_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">num_iterations</span><span class="p">)</span>
<span class="n">greedy_sample_result</span> <span class="o">=</span> <span class="p">{</span><span class="s">"opt_perm"</span><span class="p">:</span> <span class="n">greedy_opt_perm</span><span class="p">,</span> \
                        <span class="s">"opt_value"</span><span class="p">:</span> <span class="n">greedy_opt_val</span><span class="p">,</span> \
                        <span class="s">"opt_team_list"</span><span class="p">:</span> <span class="n">team_order_from_perm_list</span><span class="p">(</span><span class="n">greedy_opt_perm</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span>\
                       <span class="p">}</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>Run 0 of 10000. Current optimal value is -inf observed at run 0.
Run 1000 of 10000. Current optimal value is -14.4627 observed at run 89.
Run 2000 of 10000. Current optimal value is -14.3029 observed at run 1518.
Run 3000 of 10000. Current optimal value is -14.3029 observed at run 1518.
Run 4000 of 10000. Current optimal value is -13.9215 observed at run 3467.
Run 5000 of 10000. Current optimal value is -13.9215 observed at run 3467.
Run 6000 of 10000. Current optimal value is -13.5204 observed at run 5081.
Run 7000 of 10000. Current optimal value is -13.5204 observed at run 5081.
Run 8000 of 10000. Current optimal value is -13.5204 observed at run 5081.
Run 9000 of 10000. Current optimal value is -13.5204 observed at run 5081.
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">greedy_sample_result</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">'opt_perm':</span><span class="w"> </span><span class="err">[11,</span><span class="w"> </span><span class="err">10,</span><span class="w"> </span><span class="err">9,</span><span class="w"> </span><span class="err">7,</span><span class="w"> </span><span class="err">16,</span><span class="w"> </span><span class="err">18,</span><span class="w"> </span><span class="err">2,</span><span class="w"> </span><span class="err">12,</span><span class="w"> </span><span class="err">8,</span><span class="w"> </span><span class="err">15,</span><span class="w"> </span><span class="err">6,</span><span class="w"> </span><span class="err">17,</span><span class="w"> </span><span class="err">3,</span><span class="w"> </span><span class="err">5,</span><span class="w"> </span><span class="err">19,</span><span class="w"> </span><span class="err">4,</span><span class="w"> </span><span class="err">14,</span><span class="w"> </span><span class="err">13,</span><span class="w"> </span><span class="err">0,</span><span class="w">
              </span><span class="err">1],</span><span class="w">
 </span><span class="err">'opt_team_list':</span><span class="w"> </span><span class="err">['Leicester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">United',</span><span class="w"> </span><span class="err">'Chelsea',</span><span class="w">
                   </span><span class="err">'AFC</span><span class="w"> </span><span class="err">Bournemouth',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Bromwich</span><span class="w"> </span><span class="err">Albion',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Ham</span><span class="w"> </span><span class="err">United',</span><span class="w">
                   </span><span class="err">'Everton',</span><span class="w"> </span><span class="err">'Stoke</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Arsenal',</span><span class="w"> </span><span class="err">'Watford',</span><span class="w"> </span><span class="err">'Southampton',</span><span class="w">
                   </span><span class="err">'Sunderland',</span><span class="w"> </span><span class="err">'Hull</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Middlesbrough',</span><span class="w"> </span><span class="err">'Liverpool',</span><span class="w">
                   </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Tottenham</span><span class="w"> </span><span class="err">Hotspur',</span><span class="w"> </span><span class="err">'Swansea</span><span class="w"> </span><span class="err">City',</span><span class="w">
                   </span><span class="err">'Burnley',</span><span class="w"> </span><span class="err">'Crystal</span><span class="w"> </span><span class="err">Palace'],</span><span class="w">
 </span><span class="err">'opt_value':</span><span class="w"> </span><span class="err">-12.625602276029568</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>So it looks like greedy sampling has given us better results than the pure strategy! Can we do better though?</p>

<h2 id="simulated-annealing-strategy">Simulated Annealing Strategy</h2>

<p><a href="https://en.wikipedia.org/wiki/Simulated_annealing">Simulated annealing</a> (SA) is a popular heuristic strategy for th travelling salesman problem and other combinatorial optimisation problems. The basic idea is to model the solution space of our problem as the physical states in a thermodynamical system. Higher cost solutions correspond to higher energy states and vice versa. We allow the system to ‘evolve’ under this thermodynamic model, while decreasing the virtual temperature, in analogy to a thermal annealing process.</p>

<p>We start at an inverse temperature $\beta_i$ and finish at $\beta_f$. Dynamics is modelled as a Markov chain with transition probabilities $\mathbb{P}(\sigma \to \sigma’) = \min{1,\ \exp(- \beta(\sigma - \sigma’))}$. The temperature $\beta$ changes according to some fixed schedule. For the Markov chain we require a number of ‘burn-in’ steps to allow the chain to mix.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">metropolis_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="s">"""
    Returns a Metropolis-sampled permutation after `burn_in` steps, starting from `start_perm`.
    Acceptance probability ratio is winning probability ratio, beta is inverse temperature.
    """</span>
    <span class="c">## Check dims of X, start_perm ok</span>
    <span class="n">num_weeks</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_teams</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_teams</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)):</span>
        <span class="k">raise</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">(</span><span class="s">"X needs to have </span><span class="si">%</span><span class="s">d rows, has </span><span class="si">%</span><span class="s">d."</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_teams</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
    <span class="k">if</span><span class="p">(</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">start_perm</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_perm</span><span class="p">))))):</span>
        <span class="k">raise</span><span class="p">(</span><span class="nb">ValueError</span><span class="p">(</span><span class="s">"start_perm doesn't contain all integers from 0 to </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">start_perm</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)))</span>
    
    <span class="n">out_perm</span> <span class="o">=</span> <span class="n">start_perm</span><span class="p">[:]</span>
    <span class="n">out_val</span> <span class="o">=</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">out_perm</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">burn_in</span><span class="p">):</span>
        <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">candidate_perm</span> <span class="o">=</span> <span class="n">out_perm</span><span class="p">[:]</span>
        <span class="n">candidate_perm</span><span class="p">[</span><span class="n">idx1</span><span class="p">],</span> <span class="n">candidate_perm</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate_perm</span><span class="p">[</span><span class="n">idx2</span><span class="p">],</span> <span class="n">candidate_perm</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="n">candidate_val</span> <span class="o">=</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">candidate_perm</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">candidate_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>  <span class="c"># evaluate_perm() is log of winnning probability</span>
        
        <span class="n">accept</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">accept</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">accept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">accept</span><span class="p">):</span>
            <span class="c"># print("accept", t, candidate_val, out_val, (np.exp(candidate_val) / np.exp(out_val)), out_perm)</span>
            <span class="n">out_perm</span> <span class="o">=</span> <span class="n">candidate_perm</span><span class="p">[:]</span>
            <span class="n">out_val</span> <span class="o">=</span> <span class="n">candidate_val</span>
            
    <span class="k">return</span> <span class="n">out_perm</span><span class="p">,</span> <span class="n">out_val</span>        
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">simulated_anneal_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">beta_f</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="s">"""
    Return a permutation sample according to the simulated annealing algorithm, 
    starting at inverse temperature `beta_i` and stopping at `beta_f`. Beta geometrically
    increases, by a factor `alpha` at each step, `burn_in` runs at each temperature.
    """</span>
    <span class="n">current_perm</span> <span class="o">=</span> <span class="n">start_perm</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">beta_i</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&lt;=</span> <span class="n">beta_f</span><span class="p">):</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">beta</span>
        <span class="n">out_perm</span><span class="p">,</span> <span class="n">out_val</span> <span class="o">=</span> <span class="n">metropolis_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">current_perm</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
        <span class="n">current_perm</span> <span class="o">=</span> <span class="n">out_perm</span><span class="p">[:]</span>
    <span class="k">return</span> <span class="n">out_perm</span><span class="p">,</span> <span class="n">out_val</span>    
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">simulated_anneal_sample_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">beta_f</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">):</span>
    <span class="s">"""
    Return the permutation giving the maximum winning probability after `num_samples`
    SA samples.
    """</span>
    <span class="n">optimal_perm</span> <span class="o">=</span> <span class="n">start_perm</span><span class="p">[:]</span>
    <span class="n">optimal_val</span> <span class="o">=</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">optimal_perm</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"Run </span><span class="si">%</span><span class="s">d of </span><span class="si">%</span><span class="s">d. Current optimal value is </span><span class="si">%.4</span><span class="s">f."</span> \
                  <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">,</span> <span class="n">optimal_val</span><span class="p">))</span>
        <span class="n">sample_perm</span><span class="p">,</span> <span class="n">sample_val</span> <span class="o">=</span> <span class="n">simulated_anneal_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">beta_f</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sample_val</span> <span class="o">&gt;</span> <span class="n">optimal_val</span><span class="p">):</span>
            <span class="n">optimal_val</span> <span class="o">=</span> <span class="n">sample_val</span>
            <span class="n">optimal_perm</span> <span class="o">=</span> <span class="n">sample_perm</span><span class="p">[:]</span>
    <span class="k">return</span> <span class="n">optimal_perm</span><span class="p">,</span> <span class="n">optimal_val</span>    
</code></pre>
</div>

<h3 id="tune-the-hyperparameters">Tune the hyperparameters</h3>

<p>Naturally, we don’t just want to guess at the hyperparamters in the SA strategy, we need to select them somehow.</p>

<p>Here we’re going to use a very naive method: grid search. Let’s fix some of the hyperparameters to sensible values to not have to test too many combinations. These include the final inverse temperature $\beta_f= 50$ and the <code class="highlighter-rouge">burn_in=200</code>. We’ll set $\beta_f = 50$ because $e^{-50}$ is <em>tiny</em> so more or less zero acceptance probability for any transition lowering the energy and <code class="highlighter-rouge">burn_in=200</code> since it is roughly the number of possible transitions from a given state $n(n-1)/2$. We’ll use the greedy stategy as a starting state.</p>

<p>We <em>are</em> going to vary the initial inverse temperature $\beta_i$ and the multiplier, $\alpha$.</p>

<p>We’ll give each of the $(\beta_i, \alpha)$ pairs 25 goes to show us what they’re made of. The best pair will then be used for more runs to give us the SA strategy generated permutation.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">beta_f</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">burn_in</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">start_perm</span> <span class="o">=</span> <span class="n">greedy_perm</span>
<span class="n">num_runs</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>
<span class="n">beta_is</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="n">SA_hyperparam_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'alpha'</span><span class="p">,</span> <span class="s">'beta_i'</span><span class="p">,</span> <span class="s">'SA_opt_val'</span><span class="p">,</span> <span class="s">'SA_opt_perm'</span><span class="p">])</span>

<span class="k">for</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta_i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">alphas</span><span class="p">,</span> <span class="n">beta_is</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Testing alpha = </span><span class="si">%.3</span><span class="s">f, beta_i = </span><span class="si">%.4</span><span class="s">f "</span> <span class="o">%</span> <span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">))</span>
    <span class="n">SA_opt_perm</span><span class="p">,</span> <span class="n">SA_opt_val</span> <span class="o">=</span> \
            <span class="n">simulated_anneal_sample_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">beta_f</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">)</span>
    <span class="n">SA_hyperparam_results</span> <span class="o">=</span> <span class="n">SA_hyperparam_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">'alpha'</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s">'beta_i'</span><span class="p">:</span> <span class="n">beta_i</span><span class="p">,</span> <span class="s">'SA_opt_val'</span><span class="p">:</span> <span class="n">SA_opt_val</span><span class="p">,</span> <span class="s">'SA_opt_perm'</span><span class="p">:</span> <span class="n">SA_opt_perm</span><span class="p">},</span>\
                                <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>... lots of output ...
</code></pre>
</div>

<p>Whoa, that took a while! But it seems to have paid off</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">SA_hyperparam_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">SA_hyperparam_results</span><span class="p">[</span><span class="s">'SA_opt_val'</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>alpha                                                        1.2
beta_i                                                       0.5
SA_opt_val                                              -10.4662
SA_opt_perm    [0, 13, 4, 5, 11, 19, 2, 6, 18, 15, 7, 17, 3, ...
Name: 34, dtype: object
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">beta_f</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">burn_in</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">start_perm</span> <span class="o">=</span> <span class="n">greedy_perm</span>
<span class="n">num_runs</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">beta_i</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">SA_opt_perm</span><span class="p">,</span> <span class="n">SA_opt_val</span> <span class="o">=</span> \
        <span class="n">simulated_anneal_sample_strategy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">burn_in</span><span class="p">,</span> <span class="n">start_perm</span><span class="p">,</span> <span class="n">beta_i</span><span class="p">,</span> <span class="n">beta_f</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>... lots of output ...
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">SA_sample_result</span> <span class="o">=</span> <span class="p">{</span><span class="s">"opt_perm"</span><span class="p">:</span> <span class="n">SA_opt_perm</span><span class="p">,</span> \
                    <span class="s">"opt_value"</span><span class="p">:</span> <span class="n">SA_opt_val</span><span class="p">,</span> \
                    <span class="s">"opt_team_list"</span><span class="p">:</span> <span class="n">team_order_from_perm_list</span><span class="p">(</span><span class="n">SA_opt_perm</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span>\
                    <span class="p">}</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">SA_sample_result</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">'opt_perm':</span><span class="w"> </span><span class="err">[4,</span><span class="w"> </span><span class="err">13,</span><span class="w"> </span><span class="err">2,</span><span class="w"> </span><span class="err">0,</span><span class="w"> </span><span class="err">11,</span><span class="w"> </span><span class="err">19,</span><span class="w"> </span><span class="err">8,</span><span class="w"> </span><span class="err">6,</span><span class="w"> </span><span class="err">18,</span><span class="w"> </span><span class="err">15,</span><span class="w"> </span><span class="err">7,</span><span class="w"> </span><span class="err">17,</span><span class="w"> </span><span class="err">3,</span><span class="w"> </span><span class="err">12,</span><span class="w"> </span><span class="err">1,</span><span class="w"> </span><span class="err">14,</span><span class="w"> </span><span class="err">5,</span><span class="w"> </span><span class="err">10,</span><span class="w"> </span><span class="err">9,</span><span class="w">
              </span><span class="err">16],</span><span class="w">
 </span><span class="err">'opt_team_list':</span><span class="w"> </span><span class="err">['Manchester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Swansea</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Everton',</span><span class="w"> </span><span class="err">'Burnley',</span><span class="w">
                   </span><span class="err">'Leicester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Liverpool',</span><span class="w"> </span><span class="err">'Arsenal',</span><span class="w"> </span><span class="err">'Southampton',</span><span class="w">
                   </span><span class="err">'West</span><span class="w"> </span><span class="err">Ham</span><span class="w"> </span><span class="err">United',</span><span class="w"> </span><span class="err">'Watford',</span><span class="w"> </span><span class="err">'AFC</span><span class="w"> </span><span class="err">Bournemouth',</span><span class="w">
                   </span><span class="err">'Sunderland',</span><span class="w"> </span><span class="err">'Hull</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Stoke</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Crystal</span><span class="w"> </span><span class="err">Palace',</span><span class="w">
                   </span><span class="err">'Tottenham</span><span class="w"> </span><span class="err">Hotspur',</span><span class="w"> </span><span class="err">'Middlesbrough',</span><span class="w"> </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">United',</span><span class="w">
                   </span><span class="err">'Chelsea',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Bromwich</span><span class="w"> </span><span class="err">Albion'],</span><span class="w">
 </span><span class="err">'opt_value':</span><span class="w"> </span><span class="err">-10.540821987149268</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h2 id="convex-programming-strategy">Convex Programming Strategy</h2>

<p>The SA strategy did pretty well. There is one more direction of attack that I’d like us to go down, so let’s investigate.</p>

<h3 id="theory">Theory</h3>

<p>Let $\widetilde{X}$ be the matrix with entries given by</p>

<script type="math/tex; mode=display">[\widetilde{X}]_{i,j} = \ln X_{i,j} = \ln p^{(i)}_j</script>

<p>Now consider the optimisation problem</p>

<script type="math/tex; mode=display">\max_{\sigma \in \mathbb{S}_n} \operatorname{Tr}(P_{\sigma} \widetilde{X} ), \tag{$\mathsf{X}$}</script>

<p>where $P_\sigma$ is the <em>permutation matrix</em> assoiated to the permutation $\sigma$, with elements $[P_\sigma]_{i,j} = \delta^{\sigma(i)}_j$. We’ll call this problem $\mathsf{X}$ with optimal value $\operatorname{OPT}(\mathsf{X})$.</p>

<p>The solution to $\mathsf{X}$ is also the permutation with maximum winning probability! Why?</p>

<script type="math/tex; mode=display">\operatorname{Tr}(P_{\sigma} \widetilde{X} ) = \sum_{i,j} [P_{\sigma}]_{i,j}  [\widetilde{X}]_{i,j} = \sum_{i,j} \delta^{\sigma(i)}_j \ln p^{(i)}_j = \sum_i \ln p^{(i)}_{\sigma(i)} = \ln \left( \prod_i  p^{(i)}_{\sigma(i)} \right) = \ln \left( \mathbb{P}(\sigma \text{ wins}) \right).</script>

<p>Since $\ln(\,\cdot\,)$ is a monotonic function, maximising $\ln \left( \prod_i  p^{(i)}<em>{\sigma(i)} \right)$ maximises $\prod_i  p^{(i)}</em>{\sigma(i)} = \mathbb{P}(\sigma \text{ wins})$.</p>

<p>“So what?” one might think – we still have a search space of permutations on $n$ elements with size $n!$ – all we’ve done is rewrite the original problem using matrices. However, writing the problem this way suggests a new means of attack.</p>

<p>Let’s try taking the convex relaxation of $\mathsf{X}$, calling it $\mathsf{convX}$:</p>

<script type="math/tex; mode=display">\max_{P \in \mathcal{B}_n} \operatorname{Tr}(P \widetilde{X} ), \tag{$\mathsf{convX}$}</script>

<p>We have a new object here, $\mathcal{B}<em>n$, which is known as the <a href="https://en.wikipedia.org/wiki/Birkhoff_polytope">*Birkhoff polytope*</a>. It is the convex hull of all $n \times n$ permutation matrices. This means that every $P\in \mathcal{B}_n$ is a *doubly-stochastic matrix*, a matrix where every element $[P</em>{i,j}]\in[0,1]$ and all of its rows and columns sum to $1$.</p>

<p>Let’s think about $\mathsf{convX}$ for a second here: we are optimising a linear function of nonnegative real variables subject to linear constraints; this is just a linear program! We can leverage the theory and algorithms for solving linear programs to help us find a good solution to $\mathsf{X}$.</p>

<p><strong>Theorem.</strong> <em>There is an optimal solution to $\mathsf{convX}$. Moreover, there is an optimal solution at an extreme point of $\mathcal{B}_n$.</em></p>

<p><em>Proof.</em> The set $\mathcal{B}<em>n$ is compact and $\mathsf{convX}$ is a maximisation problem over $\mathcal{B}_n$, so there is a solution to $\mathsf{convX}$, call it $P^\star$. We can write $P^\star = \sum</em>{\sigma \in \mathbb{S}<em>n}\alpha^\star</em>\sigma P_\sigma$ from the definition of $\mathcal{B}<em>n$, where $\alpha^\star</em>\sigma \in [0,1]$ and $\sum_{\sigma \in \mathbb{S}<em>n} \alpha^\star</em>\sigma = 1$. By linearity we have $\operatorname{OPT}(\mathsf{convX}) = \operatorname{Tr}(P^\star \widetilde{X}) = \sum_{\sigma \in \mathbb{S}<em>n} \alpha^\star</em>\sigma \operatorname{Tr}(P_\sigma \widetilde{X})$. 
There is no $\sigma \in \mathbb{S}<em>n$ such that $\operatorname{Tr}(P</em>\sigma \widetilde{X}) &gt; \operatorname{OPT}(\mathsf{convX})$, otherwise $P^\star$ is not optimal. Now, consider the set $S^\star = \left{\sigma \in \mathbb{S}<em>n \, \middle\vert \, \operatorname{Tr}(P</em>\sigma \widetilde{X}) = \operatorname{OPT}(\mathsf{convX}) \right}$. The set $S^\star$ is non-empty from the following: suppose $S^\star = \emptyset$. Then, $P^\star$ is a convex sum of terms $P_\sigma$ where each $\operatorname{Tr}(P_\sigma \widetilde{X}) &lt; \operatorname{OPT}(\mathsf{convX})$, giving $\operatorname{Tr}(P^\star\widetilde{X}) &lt; \operatorname{OPT}(\mathsf{convX})$ from linearity; but $\operatorname{OPT}(\mathsf{convX}) = \operatorname{Tr}(P^\star \widetilde{X})$ by definition. Thus we have that $P^\star = \sum_{\sigma \in S^\star}\alpha^\star_\sigma P_\sigma$, where $\alpha^\star_\sigma \in [0,1]$ and $\sum_{\sigma \in S^\star} \alpha^\star_\sigma = 1$. Clearly, any $P_\sigma$ for $\sigma \in S^\star$ is an optimal solution to $\mathsf{convX}$ and also an extreme point of $\mathcal{B}_n$, by definition.</p>

<p><strong>Corollary.</strong> $\operatorname{OPT}(\mathsf{X}) = \operatorname{OPT}(\mathsf{convX})$.</p>

<p>This is great news! We can find an extremal solution to $\mathsf{convX}$ and we will get the solution to $\mathsf{X}$ – an optimal permutation. Since $\mathsf{convX}$ is a linear program we can solve it quickly. Moreover, typical LP solvers usually search through extreme points and give them as a solution, so we will most likely not need to work hard to project the returned $P^\star$ to the nearest extreme point of $\mathcal{B}_n$.</p>

<h3 id="implementation-1">Implementation</h3>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">X_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">X</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">),</span> <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">teams</span><span class="p">)]</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="o">*</span><span class="n">X_tilde</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="o">*</span><span class="n">X_tilde</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sign</span><span class="o">=</span><span class="s">"negative"</span><span class="p">)</span>
<span class="n">W</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">X_tilde</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">cvx</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">W</span><span class="o">*</span><span class="n">P</span><span class="p">))</span>

<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">P</span><span class="p">,</span> <span class="n">P</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">col_sums</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">sum_entries</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
<span class="n">row_sums</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">sum_entries</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">col_sum</span> <span class="ow">in</span> <span class="n">col_sums</span><span class="p">:</span>
    <span class="n">constraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">col_sum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">for</span> <span class="n">row_sum</span> <span class="ow">in</span> <span class="n">row_sums</span><span class="p">:</span>
    <span class="n">constraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row_sum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cvx</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"status:"</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"optimal value"</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>status: optimal
optimal value -10.337805564701268
</code></pre>
</div>

<p>We have optimal value! Let’s take a look at the returned $P$ matrix.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"binary"</span><span class="p">,</span> <span class="n">fignum</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"optimal $P$</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">"binary"</span><span class="p">,</span> <span class="n">fignum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">();</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"optimal $P$, log scale</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
</code></pre>
</div>

<div align="middle" style="width:98%;">
<img src="//assets/last_man_standing_files/last_man_standing_45_0.png" />
</div>

<p>We see that it’s not quite a ${0,1}$ permutation matrix, so let’s round it and get the corrsponding team list.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">rounded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

<span class="c"># check if permutation</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">rounded</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">rounded</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>

<span class="c"># convert permutation matrix to perm_list</span>
<span class="n">cvx_opt_perm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rounded</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">cvx_result</span> <span class="o">=</span> <span class="p">{</span><span class="s">"opt_perm"</span><span class="p">:</span> <span class="n">cvx_opt_perm</span><span class="p">,</span> \
              <span class="s">"opt_value"</span><span class="p">:</span> <span class="n">evaluate_perm</span><span class="p">(</span><span class="n">cvx_opt_perm</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span> \
              <span class="s">"opt_team_list"</span><span class="p">:</span> <span class="n">team_order_from_perm_list</span><span class="p">(</span><span class="n">cvx_opt_perm</span><span class="p">,</span> <span class="n">teams</span><span class="p">)</span> \
              <span class="p">}</span>

<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">cvx_result</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="err">'opt_perm':</span><span class="w"> </span><span class="err">[1,</span><span class="w"> </span><span class="err">13,</span><span class="w"> </span><span class="err">4,</span><span class="w"> </span><span class="err">5,</span><span class="w"> </span><span class="err">11,</span><span class="w"> </span><span class="err">19,</span><span class="w"> </span><span class="err">2,</span><span class="w"> </span><span class="err">6,</span><span class="w"> </span><span class="err">8,</span><span class="w"> </span><span class="err">15,</span><span class="w"> </span><span class="err">7,</span><span class="w"> </span><span class="err">17,</span><span class="w"> </span><span class="err">3,</span><span class="w"> </span><span class="err">12,</span><span class="w"> </span><span class="err">9,</span><span class="w"> </span><span class="err">14,</span><span class="w"> </span><span class="err">18,</span><span class="w"> </span><span class="err">10,</span><span class="w"> </span><span class="err">0,</span><span class="w">
              </span><span class="err">16],</span><span class="w">
 </span><span class="err">'opt_team_list':</span><span class="w"> </span><span class="err">['Crystal</span><span class="w"> </span><span class="err">Palace',</span><span class="w"> </span><span class="err">'Swansea</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">City',</span><span class="w">
                   </span><span class="err">'Middlesbrough',</span><span class="w"> </span><span class="err">'Leicester</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Liverpool',</span><span class="w"> </span><span class="err">'Everton',</span><span class="w">
                   </span><span class="err">'Southampton',</span><span class="w"> </span><span class="err">'Arsenal',</span><span class="w"> </span><span class="err">'Watford',</span><span class="w"> </span><span class="err">'AFC</span><span class="w"> </span><span class="err">Bournemouth',</span><span class="w">
                   </span><span class="err">'Sunderland',</span><span class="w"> </span><span class="err">'Hull</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Stoke</span><span class="w"> </span><span class="err">City',</span><span class="w"> </span><span class="err">'Chelsea',</span><span class="w">
                   </span><span class="err">'Tottenham</span><span class="w"> </span><span class="err">Hotspur',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Ham</span><span class="w"> </span><span class="err">United',</span><span class="w"> </span><span class="err">'Manchester</span><span class="w"> </span><span class="err">United',</span><span class="w">
                   </span><span class="err">'Burnley',</span><span class="w"> </span><span class="err">'West</span><span class="w"> </span><span class="err">Bromwich</span><span class="w"> </span><span class="err">Albion'],</span><span class="w">
 </span><span class="err">'opt_value':</span><span class="w"> </span><span class="err">-10.337805543989093</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h2 id="strategy-comparison">Strategy comparison</h2>

<p>Let’s now compare the different strategies once and for all.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">"greedy"</span><span class="p">:</span> <span class="n">greedy_strategy_result</span><span class="p">,</span> <span class="s">"GS"</span><span class="p">:</span> <span class="n">greedy_sample_result</span><span class="p">,</span> <span class="s">"SA"</span><span class="p">:</span> <span class="n">SA_sample_result</span><span class="p">,</span> <span class="s">"cvx"</span><span class="p">:</span> <span class="n">cvx_result</span><span class="p">})</span>
<span class="n">result_df</span>
</code></pre>
</div>

<div class="table-container">
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GS</th>
      <th>SA</th>
      <th>cvx</th>
      <th>greedy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>opt_perm</th>
      <td>[11, 10, 9, 7, 16, 18, 2, 12, 8, 15, 6, 17, 3,...</td>
      <td>[4, 13, 2, 0, 11, 19, 8, 6, 18, 15, 7, 17, 3, ...</td>
      <td>[1, 13, 4, 5, 11, 19, 2, 6, 8, 15, 7, 17, 3, 1...</td>
      <td>[4, 14, 9, 8, 11, 19, 10, 6, 18, 15, 7, 2, 16,...</td>
    </tr>
    <tr>
      <th>opt_team_list</th>
      <td>[Leicester City, Manchester United, Chelsea, A...</td>
      <td>[Manchester City, Swansea City, Everton, Burnl...</td>
      <td>[Crystal Palace, Swansea City, Manchester City...</td>
      <td>[Manchester City, Tottenham Hotspur, Chelsea, ...</td>
    </tr>
    <tr>
      <th>opt_value</th>
      <td>-12.6256</td>
      <td>-10.5408</td>
      <td>-10.3378</td>
      <td>-13.507</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">10.337806</span> <span class="o">/</span> <span class="o">-</span><span class="mf">13.507041</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>2.1497772399422357
</code></pre>
</div>

<p>We have that the convex strategy wins out over the naive greedy strategy with more than twice the winning probability - and is computationally efficient!</p>

<p>Next time, we’ll back test these two strategies against one another to see how they differ on a more realistic setting. This also constitutes a test of the independence assumption we used at the beginning.</p>

  </div>

</article>

        </main>
      </div>

    <footer class="t-hackcss-footer">
  <hr />

  <h3 class="footer-heading">Danial Dervovic</h3>

  <div class="grid t-hackcss-sm-reversed-grid">

    <div class="cell -5of12">
      <div class="contact-list">
        <p>
          Danial Dervovic,
          <a href="mailto:contact@danialdervovic.com">contact@danialdervovic.com</a>
        </p>

        
          
          <span class="t-hackcss-social">
            <i class="t-hackcss-icon"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</i>
            <a href="https://github.com/ddervs">ddervs</a>
          </span>
        
          
          <span class="t-hackcss-social">
            <i class="t-hackcss-icon"><svg x="0px" y="0px" viewBox="0 0 430.117 430.117" style="enable-background:new 0 0 430.117 430.117;" xml:space="preserve">
<g>
<path id="LinkedIn" d="M430.117,261.543V420.56h-92.188V272.193c0-37.271-13.334-62.707-46.703-62.707   c-25.473,0-40.632,17.142-47.301,33.724c-2.432,5.928-3.058,14.179-3.058,22.477V420.56h-92.219c0,0,1.242-251.285,0-277.32h92.21   v39.309c-0.187,0.294-0.43,0.611-0.606,0.896h0.606v-0.896c12.251-18.869,34.13-45.824,83.102-45.824   C384.633,136.724,430.117,176.361,430.117,261.543z M52.183,9.558C20.635,9.558,0,30.251,0,57.463   c0,26.619,20.038,47.94,50.959,47.94h0.616c32.159,0,52.159-21.317,52.159-47.94C103.128,30.251,83.734,9.558,52.183,9.558z    M5.477,420.56h92.184v-277.32H5.477V420.56z" fill="#828282"/>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g></svg>
</i>
            <a href="http://linkedin.com/in/danial-dervovic">danial-dervovic</a>
          </span>
        
      </div>
    </div>

    <div id="footer-spacer" class="cell -1of12"></div>

    <div class="cell -6of12">
      <p>Personal website, blog.
</p>
    </div>
  </div>

</footer>


    </div>

  </body>

</html>
